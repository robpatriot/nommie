{$CADDY_DOMAIN} {
	# Enable compression ONLY for non-API routes
	@no_api {
		not path /api/*
		not path /health
	}
	encode @no_api gzip zstd

	# Use Cloudflare DNS for ACME (DNS-01)
	tls {
		dns cloudflare {env.CF_API_TOKEN}
	}

	# Backend auth endpoints (must go to backend)
	@backend_auth path /api/auth/login /api/auth/check-allowlist
	handle @backend_auth {
		reverse_proxy backend:3001
	}

	# All other NextAuth routes → frontend
	@nextauth path /api/auth/*
	handle @nextauth {
		reverse_proxy frontend:3000
	}

	# Frontend Next.js API route for websocket token → frontend
	@ws_token path /api/ws-token
	handle @ws_token {
		reverse_proxy frontend:3000
	}

	# All other API routes → backend
	@api path /api/*
	handle @api {
		reverse_proxy backend:3001
	}

	# Health endpoint → backend
	@health path /health
	handle @health {
		reverse_proxy backend:3001
	}

	# WebSocket endpoint → backend
	@ws path /ws /ws/*
	handle @ws {
		reverse_proxy backend:3001
	}

	# Everything else → frontend
	handle {
		reverse_proxy frontend:3000
	}
}

